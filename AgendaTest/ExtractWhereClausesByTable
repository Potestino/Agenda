-- ============================================
-- Insert a new Workflow Template (MySQL)
-- ============================================
START TRANSACTION;

-- 1) Template
INSERT INTO WorkflowTemplates (Name, Description, Config, CreatedBy)
VALUES (
  'Orders & Restatements v1',
  'Imports Orders and Restatements from Excel workbook; one item per row.',
  JSON_OBJECT('dateFormat','yyyy-MM-dd','trimStrings', true),
  'system'
);
SET @TemplateId = LAST_INSERT_ID();

-- 2) Tab: Orders  (expects header row; data from row 2)
INSERT INTO WorkflowTemplateTabs
(TemplateId, TabName, HasHeader, StartRow, UniqueKeyExpr, Mapping, Constraints)
VALUES
(
  @TemplateId,
  'Orders',
  1,
  2,
  'COL:OrderId',                                           -- your importer computes ItemKey from this
  JSON_OBJECT(                                             -- column/header -> metadata key
    'A','OrderId',
    'B','CustomerId',
    'C','OrderDate',
    'D','Amount',
    'E','Currency'
  ),
  JSON_OBJECT(                                             -- simple validations
    'OrderId',   JSON_OBJECT('required', true),
    'OrderDate', JSON_OBJECT('type','date'),
    'Amount',    JSON_OBJECT('type','decimal','min',0)
  )
);
SET @OrdersTabId = LAST_INSERT_ID();

-- Optional normalized field maps for Orders (useful if you prefer structured mapping)
INSERT INTO WorkflowTemplateFieldMaps (TemplateTabId, ColumnRef, TargetKey, DataType, IsRequired, TransformExpr)
VALUES
(@OrdersTabId, 'A', 'OrderId',    'string',  1, NULL),
(@OrdersTabId, 'B', 'CustomerId', 'string',  1, NULL),
(@OrdersTabId, 'C', 'OrderDate',  'date',    1, NULL),
(@OrdersTabId, 'D', 'Amount',     'decimal', 1, NULL),
(@OrdersTabId, 'E', 'Currency',   'string',  0, 'UPPER()');

-- 3) Tab: Restatements (also header row; data from row 2)
INSERT INTO WorkflowTemplateTabs
(TemplateId, TabName, HasHeader, StartRow, UniqueKeyExpr, Mapping, Constraints)
VALUES
(
  @TemplateId,
  'Restatements',
  1,
  2,
  'COL:OrderId + "-" + COL:Line',                          -- composite key example
  JSON_OBJECT(
    'A','OrderId',
    'B','Line',
    'C','Reason',
    'D','NewAmount'
  ),
  JSON_OBJECT(
    'OrderId',   JSON_OBJECT('required', true),
    'Line',      JSON_OBJECT('type','int','min',1),
    'NewAmount', JSON_OBJECT('type','decimal')
  )
);
SET @RestTabId = LAST_INSERT_ID();

INSERT INTO WorkflowTemplateFieldMaps (TemplateTabId, ColumnRef, TargetKey, DataType, IsRequired, TransformExpr)
VALUES
(@RestTabId, 'A', 'OrderId',   'string',  1, NULL),
(@RestTabId, 'B', 'Line',      'int',     1, NULL),
(@RestTabId, 'C', 'Reason',    'string',  0, 'TRIM()'),
(@RestTabId, 'D', 'NewAmount', 'decimal', 1, NULL);

-- 4) (Optional) link an existing Workflow to this template
-- UPDATE Workflows SET TemplateId = @TemplateId WHERE Id = 123;

COMMIT;

-- Output ids (optional if youâ€™re running in a client that prints variables)
SELECT @TemplateId   AS TemplateId,
       @OrdersTabId  AS OrdersTabId,
       @RestTabId    AS RestatementsTabId;
