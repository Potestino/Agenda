-- Main template
CREATE TABLE WorkflowTemplates (
  Id            INT AUTO_INCREMENT PRIMARY KEY,
  Name          VARCHAR(150) NOT NULL,
  Description   VARCHAR(500),
  Config        JSON,                          -- general settings
  CreatedBy     VARCHAR(255) NOT NULL,
  CreatedDate   DATETIME DEFAULT CURRENT_TIMESTAMP,
  UpdatedBy     VARCHAR(255),
  UpdatedDate   DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- Tabs (sheets) this template expects
CREATE TABLE WorkflowTemplateTabs (
  Id            INT AUTO_INCREMENT PRIMARY KEY,
  TemplateId    INT NOT NULL,
  TabName       VARCHAR(100) NOT NULL,         -- Excel sheet name to look for
  HasHeader     TINYINT(1) DEFAULT 1,
  StartRow      INT DEFAULT 2,                 -- data start row
  UniqueKeyExpr VARCHAR(255),                  -- e.g. "COL:A + '-' + COL:B"
  Mapping       JSON,                          -- column -> metadata key map or transforms
  Constraints   JSON,                          -- validations per column
  FOREIGN KEY (TemplateId) REFERENCES WorkflowTemplates(Id)
);

-- Optional: field-level mapping if you prefer normalized over JSON
CREATE TABLE WorkflowTemplateFieldMaps (
  Id              INT AUTO_INCREMENT PRIMARY KEY,
  TemplateTabId   INT NOT NULL,
  ColumnRef       VARCHAR(50) NOT NULL,        -- e.g. "A", "B", or column header text
  TargetKey       VARCHAR(100) NOT NULL,       -- metadata key name
  DataType        VARCHAR(30)  NOT NULL,       -- string, int, decimal, date, bool
  IsRequired      TINYINT(1) DEFAULT 0,
  TransformExpr   VARCHAR(500),                -- optional simple expression
  FOREIGN KEY (TemplateTabId) REFERENCES WorkflowTemplateTabs(Id)
);

-- Link a Workflow to a Template (optional but useful)
ALTER TABLE Workflows
  ADD COLUMN TemplateId INT NULL,
  ADD CONSTRAINT fk_Workflows_Templates FOREIGN KEY (TemplateId) REFERENCES WorkflowTemplates(Id);

-- Enrich items to track origin
ALTER TABLE WorkflowItems
  ADD COLUMN TemplateTabId INT NULL,
  ADD COLUMN RowNumber INT NULL,
  ADD COLUMN ItemKey VARCHAR(255) NULL,        -- derived from UniqueKeyExpr
  ADD CONSTRAINT fk_WorkflowItems_TemplateTab FOREIGN KEY (TemplateTabId) REFERENCES WorkflowTemplateTabs(Id);
